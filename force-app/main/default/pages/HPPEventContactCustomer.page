<!-- C00096 2013-10-16 SHow problems with AJE calls
 Remove sort code for internal
 Cater for non card AJE calls  -->
<!-- C00187 2014-04-02 Payment none comments not saving -->
<apex:page controller="HPPEventContactCustomerController" sidebar="false" showheader="false" title="Contact Customer" action="{!autoRun}">
    <head>
        <apex:stylesheet value="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <apex:stylesheet value="https://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css"/>
        <apex:stylesheet value="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"/>
        <apex:includescript value="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" />
        
        
        <c:KendoResource IgnoreKendoDropDown="true"></c:KendoResource>
        
        
        <!-- Angular Resources -->
        <!--
        <apex:includescript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular.min.js" />
        <apex:includescript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular-animate.min.js" />
        <apex:includescript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular-sanitize.js" />
        <apex:includescript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0/angular-messages.js" />
        -->
        
        <apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.11/angular.min.js"/>
        <apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.11/angular-animate.min.js"/>
        <apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.11/angular-sanitize.js"/>
        <apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.11/angular-messages.js"/>

        <apex:stylesheet value="{!URLFOR($Resource.HPP_Includes, '/css/css.css')}"  />
        <apex:stylesheet value="{!URLFOR($Resource.HPP_Includes, '/css/wait.css')}"  />
        <apex:stylesheet value="{!URLFOR($Resource.HPP_Includes, '/css/structure.css')}"  />
        <apex:stylesheet value="{!URLFOR($Resource.HPP_Includes, '/css/modal.css')}"  />

        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/app/app.js')}"  />
        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/service/service_messagebroker.js')}"  />
        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/service/service_parameters.js')}"  />
        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/service/service_application.js')}"  />
         
        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/controller/controller_core.js')}"  />
        
        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/controller/controller_hpp_event_contact_customer.js')}"  />
        <apex:includeScript value="{!URLFOR($Resource.HPP_Includes, '/js/service/service_hpp_event_take_contact_customer.js')}"  />
        
         <script type="text/javascript">
         // AVM Changes ; Start 
             // function for refreshing AVM Charge section
             function refreshAVMCharge(){
                 setValueForAVMCharge();
             }
           function calculateReacFinanceAmt(){
            var valType = $('[id$=val]').val();
            var valTyperesult = $('[id$=val] option:selected').text();
            
            var regex = /[+-]?\d+(\.\d+)?/g;
            var floats = valTyperesult.match(regex);
            var avmOutcome = $('[id$=AvmOutcome]').val();
            var avmCharge = $('[id$=AVMCharge]').val();
            var reacFinanceRequired = $('[id$=reacFinanceRequired]').val().replace(',','');
            console.log('val1 : '+reacFinanceRequired );
            var outstandingFinanceAmount = $('[id$=outstandingFinanceAmount]').val().replace(',','');            
            console.log('val2 : '+outstandingFinanceAmount ); 
            //condition for AVM Charge change
            
            //Condition for AVM Ineligibility & AVM Charge 'No'
            if(((avmOutcome == 'AVM Ineligibility') && (avmCharge == 'Yes' || avmCharge == 'No')) || (avmCharge == 'No') || (avmCharge == '') || (avmOutcome == ''))
            {
            reacFinanceRequired = 0.00; 
            $('[id$=reacFinanceRequired]').val( reacFinanceRequired );
            
            }else 
            {
            reacFinanceRequired = {!AVMcost}; 
            $('[id$=reacFinanceRequired]').val( reacFinanceRequired );
            }
            //condition for AVM Acceptable & AVM Physical valuation with AVM charge Yes
            if(valType != '')
            {
            if((avmOutcome == 'AVM Acceptable' || avmOutcome == 'AVM Physical Valuation Required') && avmCharge =='Yes')
            {
                outstandingFinanceAmount = floats - reacFinanceRequired;
                $('[id$=outstandingFinanceAmount]').val( outstandingFinanceAmount );
            }
            else
            {
            outstandingFinanceAmount = floats;
            $('[id$=outstandingFinanceAmount]').val( outstandingFinanceAmount );
            }
            }else{//Condition for None in Select Valuation Type
            outstandingFinanceAmount = 0.00;
            $('[id$=outstandingFinanceAmount]').val( outstandingFinanceAmount );
            }
            
            var totalREACAmount = 0;
            var totalAmount = parseFloat(reacFinanceRequired) + parseFloat(outstandingFinanceAmount);
            totalAmount = totalAmount.toFixed(2);
            if(!isNaN(totalAmount )){
                totalREACAmount = totalAmount;
            }else{
                totalREACAmount = 0;
            }
            console.log(totalREACAmount );
            $('[id$=financeRequired]').val( totalREACAmount ); 
            
            }
            function checkformandatoryfields(){
            var avmOutcome = $('[id$=AvmOutcome]').val();
            var avmCharge = $('[id$=AVMCharge]').val();
            //var x = document.getElementById("completeeventpanel");
            //alert(avmOutcome+' '+avmCharge);
            if(avmOutcome == '' ||  avmCharge == ''){
                document.getElementById("completeeventpanel").style.display = "none";    
            }else{
                document.getElementById("completeeventpanel").style.display = "block";
            }
        }
        $(document).ready(function(){
            refreshAVMCharge();
            checkformandatoryfields();
            calculateReacFinanceAmt();   
            //recalculate();           
        });
        // AVM Changes ; End 
        //AVM Changes start
        function funcTest(varA){
            if(varA){
                //alert('Purchase price market value should be greater than AVM Property value and FTV% values also should be greater than AVM FTV%');
                 alert('Please note this opportunity will not be eligible for an AVM because either the FTV or the Purchase price means a physical valuation is required.');
                }
            }
       //avm changes end
        function recalculate(){
        checkformandatoryfields();
        calculateReacFinanceAmt();
        var avmOutcome = $('[id$=AvmOutcome]').val();
        var avmCharge = $('[id$=AVMCharge]').val(); 
        //alert(avmOutcome+','+avmCharge);
        if(avmOutcome != '' && avmCharge  != ''){
        //alert('if loop');
        Recalc();
        }else{
        checkForMandatoryFieldsfirst();  
        }
        var financeRequired = $('[id$=financeRequired]').val().replace(',','');
        var valFee = document.getElementById("valFee").innerHTML;
        var totalFee = document.getElementById("totalFee").innerHTML;
        valFee = '£'+financeRequired;
        var valAmt = $('[id$=valAmt]').text();
        var regex1 = /[+-]?\d+(\.\d+)?/g;
        var amt = valAmt.match(regex1);
        var valFee1 = valFee.match(regex1);
        if(parseFloat(amt) > 0.00)
        {
         if(parseFloat(amt) > parseFloat(valFee1)){
         totalFee = 0.00;
         }
         else{
         totalFee = parseFloat(valFee1) - parseFloat(amt);
         }  
        } 
        else{
        totalFee =  parseFloat(valFee1);
        }
        totalFee = Math.abs(totalFee);
        totalFee = totalFee.toFixed(2);
        totalvaluationfee = totalFee ;
        var finaltotalFee = '£'+totalFee;   
        $('#valFee').html(valFee);
        $('#totalFee').html(finaltotalFee);  
        /*var scope = angular.element($("#totalFee")).scope();
         scope.$apply(function(){
         scope.Data.TotalValuationLeftToPay = totalFee;
         alert(scope.Data.TotalValuationLeftToPay);
         })   
        var app = angular.module('hppApp', []);
        app.controller('HPPEventContactCustomerController', function($scope) {
        $scope.init = function(totalFee)
        {
        $scope.Data.TotalValuationLeftToPay = totalFee;
        console.log($scope.TotalValuationLeftToPay);
        };
        });*/
       }
       
       function ShowAllImages(){
           var valType = $('[id$=val]').val();
           
           console.log('***'+valType );
           Visualforce.remoting.Manager.invokeAction
                (
                    '{!$RemoteAction.HPPEventContactCustomerController.checkIfCustom}',
                    valType ,
                    function(result, event)
                    {
                        if(event.status)
                        {
                            if(result.result){
                                ShowAllImages2();  
                                 var divVal = document.getElementById('onRequestValType');  
                                console.log('***'+divVal);
                                divVal.style= 'display:none';  
                            }else{
                                var divVal = document.getElementById('onRequestValType');  
                                console.log('***'+result.ValueToDisplay);
                                $('[id$=onRequestVal]').val( result.ValueToDisplay);                               
                                divVal.style= 'display:block';  
                                if(result.ValueToDisplay >0){
                                    ShowAllImages2();    
                                }
                            }
                        }
                        else
                        {
                            console.log('ee**'+result);
                        }

                        
                    }
                );
            }
            
            function onChangetest(){
                callcreateOrUpdateOnRequestVal();
                console.log('Onchange**');
            }
       
        </script>
        
        
        


        <style>
            #NewCard .control-label{
                text-align: right;
            }
            
            .my-panel{
                padding:20px;
                background-color: #f5f5f5;
                margin-top:10px;
            }
            
            select[multiple], select[size]{
            width:12em;
            height:22px;
            font-size:11px;
            color: #000000;
            padding:4px 0 5px 10px;
            margin:6px 0 0 6px;
            background-color: #f5f5f5;
            display:inline-block;
            cursor: pointer;
          
            }
            
           
          
        </style>


       
    </head>
    <body ng-app="hppApp" ng-controller="controllerCore" ng-cloak="ng-cloak">
        <apex:form id="myForm">
            <div id="formWrapper">
                <!-- C00095-->
                <c:HPPSummary objacc="{!Accounts[0]}" objopp="{!opp}" objexopp="{!ExOpp}" product="{!Prod}" />
                <div id="container">
                    <table width="100%">
                        <tr>
                            <td valign="top" id="sidebar">
                                <c:HPPBOMenu oppid="{!Opp.Id}" directorid="{!Opp.ProductEventDirector__c}" />
                            </td>
                            <td valign="top" id="contenttd" ng-controller="HPPEventContactCustomerController" ng-init="Data = {
                                                                                                                    
                                                                                                                    'AdminFee':'{!exOpp.ValuationPrice__c}',
                                                                                                                    'ValuationContribution':'{!ValuationContribution}',
                                                                                                                    'TotalValuationLeftToPay':'{!TotalValuationLeftToPay}',
                                                                                                                    
                                                                                                                    'Cards':{!CardDataJson },    
                                                                                                                    'InternalAccounts':{!InternalAccounts},                                                                                                                 
                                                                                                                     
                                                                                                                     'Payment':{
                                                                                                                                'Method': '{!exOpp.Payment_Method__c}',
                                                                                                                                'OtherPaymentMethod' : '{!exOpp.Other_payment_method__c}',
                                                                                                                                'NoneComments' : '{!NoneComments}',
                                                                                                                                'InternalAccount' : ''
                                                                                                                                
                                                                                                                               },
                                                                                                                     'Address':{
                                                                                                                                     'BillingStreet' : '{!BillingStreet}',
                                                                                                                                     'BillingCity' : '{!BillingCity}',
                                                                                                                                     'BillingCounty' : '{!BillingCounty}',
                                                                                                                                     'BillingPostCode' : '{!BillingPostCode}',
                                                                                                                                     'BillingCountry' : '{!BillingCountry}'
                                                                                                                                 }
                                                                                                                     
                                                                                                                  };
                                                                                                           
                                                                                                           AccountId ='{!Acc.Id}'; ContactId='{!Acc.PersonContactId}'; OppId='{!Opp.id}';                                                                                                           
                                                                                                           AdminFeeTaken = {!PaymentTaken};
                                                                                                           IsCompleted = {!IsCompleted};
                                                                                                           EventLogId = '{!eventId}'">
                         
                                <div id="content" >
                                <apex:pageMessages id="Erromsg"></apex:pageMessages><!--HPP-AVM C0785 -->
                                <h1>Take Card Payment</h1>                                    
                                {{Data.TotalValuationLeftToPay}}
                                    <!-- new content start -->
                                    <div style="padding:10px;">
                                            <div class="row">
                                                <div class="col-sm-3">
                                                    <label>Valuation Fee</label>  
                                                </div>
                                                <div class="col-sm-3" id="valFee">     <!-- AVM Changes-->
                                                        £{{Data.AdminFee | number:2}}  
                                                </div>
                                                <div class="col-sm-3">
                                                    <label>Valuation Contribution Amount</label>  
                                                </div>
                                                <div class="col-sm-3" id="valAmt"> 
                                                        £{{Data.ValuationContribution | number:2}}
                                                </div>
                                            </div>
                                            <div class="row">
                                              <div class="col-sm-3">
                                                    <label>Total Valuation Left To Pay</label>  
                                                </div>
                                                <div class="col-sm-3" id="totalFee">   <!-- AVM Changes // -->
                                                        £{{Data.TotalValuationLeftToPay | number:2}}
                                                </div>
                                                <div class="col-sm-3" id="payment" ng-hide="{{Data.TotalValuationLeftToPay}} == 0.0">
                                                    <label>Payment Method</label>
                                                </div>
                                                <div class="col-sm-3">
                                                    <select class="form-control" id="PaymentMethod-noKendo" ng-model="Data.Payment.Method" ng-hide="AdminFeeTaken || {{Data.TotalValuationLeftToPay}} == 0.0">
                                                        <option value="">Please select</option>
                                                        <option value="Card">Card</option>
                                                        <option value="Other">Other Payment Method</option>
                                                        <option value="None">None</option>
                                                    </select>
                                                    
                                                    <span ng-show="AdminFeeTaken || {{Data.TotalValuationLeftToPay}} > 0.0">
                                                        {{Data.Payment.Method}}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div ng-show="Data.Payment.Method == 'None'">
                                                <div class="row" >
                                                    <div class="col-sm-3 col-sm-offset-6">
                                                        <label class="control-label">Payment Confirmed by Other Method</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input type="checkbox" ng-model="Data.Payment.ConfirmedOther" ng-hide="AdminFeeTaken"/>
                                                        <span ng-show="AdminFeeTaken">{{Data.Payment.ConfirmedOther ? 'Yes' : 'No'}}</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-3 col-sm-offset-6">
                                                        <label class="control-label">Comments</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <textarea class="form-control" ng-model="Data.Payment.NoneComments" ng-hide="AdminFeeTaken"/>
                                                        <span ng-show="AdminFeeTaken">{{Data.Payment.NoneComments}}</span>
                                                    </div>
                                                </div>
                                                
                                                
                                             
                                                
                                            </div>
                                                                                        
                                            
                                            <div class="row" ng-show="Data.Payment.Method == 'Other'">
                                                <div class="col-sm-3 col-sm-offset-6">
                                                    <label class="control-label">Other Payment Method</label>
                                                </div>
                                                <div class="col-sm-3">
                                                    <select class="form-control" id="OtherPaymentMethod-noKendo" ng-model="Data.Payment.OtherPaymentMethod" ng-hide="AdminFeeTaken">
                                                        <option value="">Please select</option>
                                                        <option value="Internal Transfer">Internal Transfer</option>
                                                        <option value="External Transfer">External Transfer</option>                                                   
                                                    </select>
                                                    <span ng-show="AdminFeeTaken">{{Data.Payment.OtherPaymentMethod}}</span>
                                                </div>
                                            </div>
                                            <div class="row" ng-show="Data.Payment.Method == 'Other' && Data.Payment.OtherPaymentMethod == 'Internal Transfer'">
                                                <div class="col-sm-3 col-sm-offset-6">
                                                    <label class="control-label">Account Number</label>
                                                </div>
                                                <div class="col-sm-3">
                                                    <select ng-hide="AdminFeeTaken" class="form-control" ng-options="option.Key as option.Value  for option in Data.InternalAccounts" id="InternalAccount-noKendo" ng-model="Data.Payment.InternalAccount" ng-show="Data.InternalAccounts && Data.InternalAccounts > 0">
                                                                                                                                                           
                                                    </select>
                                                    <span ng-show="AdminFeeTaken">{{Data.InternalAccount}}</span>
                                                    
                                                    <div class="alert alert-danger" ng-show="!Data.InternalAccounts || Data.InternalAccounts == 1">
                                                        There are no internal accounts
                                                    </div>                                                    
                                                </div>
                                            </div>
                                            
                                            <div class="row" ng-show="Data.Payment.Method == 'Other' && Data.Payment.OtherPaymentMethod == 'External Transfer'">
                                                <div class="col-sm-3 col-sm-offset-6">
                                                    <label class="control-label">Comments</label>
                                                </div>
                                                <div class="col-sm-3">
                                                    <textarea class="form-control" ng-model="Data.Payment.ExternalComments" ng-hide="AdminFeeTaken"/>                                                        
                                                    <span ng-show="AdminFeeTaken">{{Data.Payment.ExternalComments}}</span>
                                                </div>
                                            </div>
                                            
                                            
                                            
                                            
                                           <!-- card details and payment buttons --> 
                                            
                                           <div ng-hide="AdminFeeTaken">
                                            
                                            
                                            <div class="row" ng-show="Data.Payment.Method == 'Other'">
                                                <div style="text-align:center;" ng-show="(Data.Payment.OtherPaymentMethod == 'Internal Transfer' && Data.Payment.InternalAccount) || (Data.Payment.OtherPaymentMethod == 'External Transfer' && Data.Payment.ExternalComments)">
                                                        <button type="button" ng-click="TakeOtherPayment()" style="width:150px;display:inline;" class="k-button">Take Payment</button>
                                            </div>
                                             
                                            
                                            </div>
                                            
                                            <div class="row" ng-show="Data.Payment.Method == 'None'">
                                                <div style="text-align:center;" ng-show="(Data.Payment.ConfirmedOther && Data.Payment.NoneComments)">
                                                        <button type="button" ng-click="TakeOtherPayment()" style="width:150px;display:inline;" class="k-button">Take Payment</button>
                                                </div>                                     
                                            
                                            </div>


                                            <div ng-show="Data.Payment.Method == 'Card'">

                                                
                                                <div id="SelectCard" ng-show="!ShowNewCard" class="my-panel">
                                                    
                                                    <div style="text-align:center;">
                                                            <button type="button" style="width:100px;display:inline;width:150px;" ng-click="CreateNewCard()" class="k-button">New Card</button>
                                                    </div>
                                                    
                                                    <div>
                                                        <table class="table">
                                                
                                                            <thead>
                                                            <tr>
                                                                <th>Action</th><th>Card Number</th><th>Card Type</th><th>Expiry Date</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr ng-repeat="card in Data.Cards">
                                                                    <td><a href="#{{card.CardId}}" ng-click="SelectCard(card)">Select Card</a></td>
                                                                    <td>{{card.CardNumber}}</td>
                                                                    <td>{{card.CardType}}</td>
                                                                    <td>******</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
    
    
                                                <div id="CardDetails" ng-show="SelectedCard && !ShowNewCard" class="my-panel">
                                                    <label>Selected Card Details</label>
                                                
                                                    <div class="row">
                                                        <label class="control-label col-sm-2 col-sm-offset-1">Card Number</label>
                                                        <div class="col-sm-3">
                                                            {{SelectedCard.CardNumber}}
                                                        </div>
                                                    </div>   
                                                    <div class="row">
                                                        <label class="control-label col-sm-2 col-sm-offset-1">Card Type</label>
                                                        <div class="col-sm-3">
                                                            {{SelectedCard.CardType}}
                                                        </div>
                                                    </div> 
                                                    <div style="text-align:center;">
                                                        <button type="button" ng-click="TakePayment()" style="width:150px;display:inline;" class="k-button">Take Payment</button>
                                                    </div>                                            
                                                </div>
    
    
    
                                                <div id="NewCard" ng-show="ShowNewCard" class="my-panel">
                                                    <div>
                                                        <label>New Card Details</label>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-sm-6">
                                                            <div class="row">                                                                                                                        
                                                                <label class="col-sm-4 control-label">Billing Street</label>
                                                                <div class="col-sm-5">
                                                                    <input type="text" class="form-control" ng-model="NewCard.BillingStreet"/>                                                                  
                                                                </div>                                                          
                                                            </div>
                                                            <div class="row">                                                                                                                        
                                                                <label class="col-sm-4 control-label">Billing City</label>
                                                                <div class="col-sm-5">
                                                                    <input type="text" class="form-control" ng-model="NewCard.BillingCity"/>                                                                  
                                                                </div>                                                          
                                                            </div>
                                                            <div class="row">                                                                                                                        
                                                                <label class="col-sm-4 control-label">Billing County</label>
                                                                <div class="col-sm-5">
                                                                    <input type="text" class="form-control" ng-model="NewCard.BillingCounty"/>                                                                  
                                                                </div>                                                          
                                                            </div>
                                                            <div class="row">                                                                                                                        
                                                                <label class="col-sm-4 control-label">Billing Country</label>
                                                                <div class="col-sm-5">
                                                                     
                                                                    <input type="text" class="form-control" ng-model="NewCard.BillingCountry"/>                                                              
                                                                </div>                                                          
                                                            </div>
                                                            <div class="row">                                                                                                                        
                                                                <label class="col-sm-4 control-label">Billing Post Code</label>
                                                                <div class="col-sm-5">
                                                                    <input type="text" class="form-control" ng-model="NewCard.BillingPostCode"/>                                                                  
                                                                </div>                                                          
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-6">
                                                            <div class="row">
                                                                <label class="col-sm-4 control-label">Card Currency</label>
                                                                <div class="col-sm-5">
                                                                <select class="form-control" id="CardCurrency-noKendo" ng-model="NewCard.CardCurrency">
                                                                        <option>GBP</option>
                                                                        <option>EUR</option>
                                                                        <option>USD</option>
                                                                    </select>
                                                                 </div>
                                                            </div>
                                                        
                                                            <div class="row">                                                            
                                                                    <label class="col-sm-4 control-label">Card Type</label>
                                                                    <div class="col-sm-5">
                                                                    <select class="form-control" id="CardType-noKendo" ng-model="NewCard.CardType">
                                                                        <option>Visa Debit</option>
                                                                        <option>Electron</option>
                                                                        <option>Maestro</option>
                                                                        <option>MasterCard Debit</option>
                                                                        <option>MasterCard</option>
                                                                        <option>Visa</option>
                                                                    </select>
                                                                    </div>
                                                                
                                                            </div>
                                                            
                                                            <div class="row">                                                            
                                                                    <label class="col-sm-4 control-label">Issue Number</label>
                                                                    <div class="col-sm-5">
                                                                        <input type="text" class="form-control" ng-model="IssueNumber"/>                                                                  
                                                                    </div>
                                                                
                                                            </div>
                                                            <div class="row">                                                            
                                                                    <label class="col-sm-4 control-label">Card Number</label>
                                                                    <div class="col-sm-5">
                                                                        <input type="text" class="form-control" ng-model="NewCard.CardNumber"/>                                                                  
                                                                    </div>
                                                                
                                                            </div>
                                                            <div class="row">                                                            
                                                                    <label class="col-sm-4 control-label">Security Code</label>
                                                                    <div class="col-sm-5">
                                                                        <input type="text" class="form-control" ng-model="NewCard.SecurityCode"/>                                                                  
                                                                    </div>
                                                                
                                                            </div>
                                                            
                                                            <div class="row">                                                            
                                                                    <label class="col-sm-4 control-label">Expiry Date</label>
                                                                    <div class="col-sm-5">
                                                                        <input type="text" style="width:50px;display:inline;" class="form-control" ng-model="NewCard.ExpiryMonth"/>    
                                                                        /                                                            
                                                                        <input type="text" style="width:80px;display:inline;" class="form-control" ng-model="NewCard.ExpiryYear"/>
                                                                    </div>                                                            
                                                            </div>
                                                            
                                                            <div class="row">                                                            
                                                                    <label class="col-sm-4 control-label">Valid From</label>
                                                                    <div class="col-sm-5">
                                                                        <input type="text" style="width:50px;display:inline;" class="form-control" ng-model="NewCard.FromMonth"/>    
                                                                        /                                                              
                                                                        <input type="text" style="width:80px;display:inline;" class="form-control" ng-model="NewCard.FromYear"/>
                                                                    </div>                                                            
                                                            </div>
                                                            
                                                            
                                                            
                                                        </div>
                                                   
                                                    </div>
                                                    
                                                    <div  ng-show="SaveCardErrors" class="alert alert-danger">
                                                        <ul>
                                                            <li ng-repeat="error in SaveCardErrors" >{{error}}</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div style="text-align:center;">
                                                        <button style="width:100px;display:inline;" type="button" class="k-button" ng-click="Save()">Save</button>
                                                        <button style="width:100px;display:inline;" type="button" class="k-button" ng-click="ShowNewCard = false;">Cancel</button>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                             <!--AVM Changes start-->
                                 <div class="row">
                                    <div class="form-group">
                                        <div class="col-sm-3">
                                            <label> Select AVM OutCome</label>
                                            <apex:inputField styleclass="form-control" id="AvmOutcome" value="{!ExOpp.AVM_OutCome__c}" onchange="refreshAVMCharge();calculateReacFinanceAmt()"  />
                                            <apex:actionFunction name="setValueForAVMCharge" rerender="AVMChargeValue"/>
                                        </div>
                                         <apex:outputPanel id="ValuationType">
                                         <div class="col-sm-3">
                                            Select valuation type
                                            <apex:selectList styleClass="form-control" value="{!ValuationId }" onChange="ShowAllImages(); return false;" size="1" id="val">                                        
                                          <!--  <apex:actionSupport event="onchange" action="{!SaveValuation}" rerender="" /> -->                                           
                                                <apex:selectOptions id="options" value="{!Valuations}"> </apex:selectOptions>
                                            </apex:selectList>
                                            <apex:actionStatus id="actStatusId" >
                                                <apex:facet name="start" >
                                                  <img src="{!URLFOR($Resource.HPP_Includes, '/css/Photo/spinner.gif')}" width="38" height="38" />                    
                                                </apex:facet>
                                            </apex:actionStatus>
                                           <apex:actionFunction name="ShowAllImages2" action="{!SaveValuation}" status="actStatusId" onComplete="calculateReacFinanceAmt();" rerender="resultPanel"/> 
                                            
                                        </div>
                                        
                                        <div class="col-sm-3" id="onRequestValType" style="{!if(displayRequestVal,'','display:none')}">
                                           On Request Valuation Price
                                            <apex:inputText value="{!onRequestVal}"  id="onRequestVal" onchange="onChangetest();"/>
                                        </div>
                                        </apex:outputPanel>
                                        <div class="col-sm-3">
                                        
                                        <label> Select AVM Charge</label>
                                        <apex:outputpanel id="AVMChargeValue">
                                           <!-- <apex:inputField styleclass="form-control" value="{!ExOpp.AVM_Charge__c }" id="AVMCharge" onchange="calculateReacFinanceAmt()"/>  -->   
                                           <apex:selectlist styleClass="form-control" value="{!ExOpp.AVM_Charge__c }" id="AVMCharge" size="1"  onchange="calculateReacFinanceAmt()">     
                                                <apex:selectOptions value="{!itemsFinance}"/>                            
                                            </apex:selectlist>   
                                            
                                         </apex:outputpanel>                      
                                         </div>
                                           
                                     </div>
                                     
                                  </div>
                             <!--AVM Changes end-->   
                <apex:outputPanel id="resultPanel">              
               <div class="row">
                  <div class="form-group">
                      <div class="col-sm-3">
                          <label></label>
                      </div>
                      <div class="col-sm-3">
                          
                      </div>
                      <div class="col-sm-3">
                          <label>AVM Cost</label>
                      </div>
                      <div class="col-sm-3">
                         <apex:inputField style="height:30px;" styleClass="form-control" value="{!av.AVM_Cost__c}" id="reacFinanceRequired" html-disabled="true" />
                         
                      </div>
                  </div>
                </div>
                 <div class="row">
                  <div class="form-group">
                      <div class="col-sm-3">
                          <label></label>
                      </div>
                      <div class="col-sm-3">
                          
                      </div>
                      <div class="col-sm-3">
                          <label>Physical Valuation Cost </label>
                      </div>
                      <div class="col-sm-3">
                            <input type="text" style="height:30px;display:inline;" class="form-control" value="{!ExOpp.Physical_Valuation_Cost__c}" id="outstandingFinanceAmount" readonly="readonly"/>
                        
                      </div>
                  </div>
              </div>
               <div class="row">
                  <div class="form-group">
                      <div class="col-sm-3">
                          <label></label>
                      </div>
                      <div class="col-sm-3">
                          
                      </div>
                      <div class="col-sm-3">
                          <label>Total Valuation Cost </label>
                      </div>
                      <div class="col-sm-3">
                          <apex:inputField style="height:30px;" styleClass="form-control" value="{!ExOpp.Total_Valuation_Cost__c}" id="financeRequired" html-disabled="true"/>
                      </div>
                  </div>
              </div>  
              </apex:outputpanel>
              <div  style="text-align:center;">
                  <apex:commandButton id="btn" styleClass="k-button" value="Recalculate Valuation Fee" onclick="checkEligibilityForAVM();recalculate();return false;" />
                  <apex:actionFunction name="checkForMandatoryFieldsfirst" action="{!checkForMandatoryFields}" rerender="Erromsg"/>
                  <apex:actionFunction name="Recalc" action="{!Recalc}" rerender="valFee"/>
                  <apex:actionFunction name="checkEligibilityForAVM" action="{!checkEligibilityForAVM}" oncomplete="funcTest({!isChanged});"/>
                  <!--<apex:actionFunction name="checkMandatoyFields" action="{!checkMandatoyFields}" reRender="Erromsg"/>-->
                  <apex:actionFunction name="callcreateOrUpdateOnRequestVal" action="{!createOrUpdateOnRequestVal}" status="actStatusId" onComplete="ShowAllImages2();" rerender="ValuationType"/>
                  
              </div>
            <!--AVM changes End-->
                 
                                            <div class="alert alert-success" ng-show="AdminFeeTaken" style="text-align:center;margin-top:20px;">
                                                <div ng-show="PaymentStatus != 2">
                                                    Payment has been taken
                                                </div>
                                                <div ng-show="PaymentStatus == 2">
                                                    Payment has been suspended
                                                </div>
                                                <div ng-show="PaymentStatus == 2" class="alert alert-warning">
                                                    <!--The card payment attempt has been suspended. Please raise a case for payments.-->
                                                    The card payment attempt has been suspended and a case will now be raised for payments. Please ensure case is completed. 
                                                
                                                    <!--C0638-->
                                                    <div> Please select the type of case you would like to generate (suspend cancel / suspend release): &nbsp;  
                                                    <apex:selectList style="font-style:normal;" id="CaseType" value="{!CaseTypeSelected}">
                                                        <apex:selectOption itemLabel="Suspended-Cancel" itemValue="Suspended-Cancel"/>
                                                        <apex:selectOption itemLabel="Suspended-Release" itemValue="Suspended-Release"/>
                                                    </apex:selectList>
                                                    </div>
                                                    <div  style="text-align:center;">
                                                       <apex:commandButton style="width:100px;display:inline;font-weight:normal" styleClass="k-button" value="Create Case" action="{!CreateCase}"></apex:commandButton>
                                                    </div>                                               
                                                    <!--C0638 end-->
                                               </div>
                                            </div>
                                            
                                            <div  ng-show="Errors" class="alert alert-danger" style="margin-top:10px;">
                                                        <ul>
                                                            <li ng-repeat="error in Errors" >{{error}}</li>
                                                        </ul>
                                                    </div>
                                            <!--<apex:outputpanel rendered="{!If(AND(ExOpp.AVM_OutCome__c==null,ExOpp.AVM_Charge__c==null),false,true)}">-->
                                            <div id="completeeventpanel" style="text-align:center;margin-top:20px;" ng-show="(!IsCompleted && AdminFeeTaken) || {{Data.TotalValuationLeftToPay}} == 0.0">
                                                <button type="button" ng-click="Complete()" class="k-button" style="width:150px;display:inline;">Complete Event</button>
                                             
                                            </div>
                                            <!--</apex:outputpanel>-->
                                        </div>
                                            <!-- new content end -->
                                    
                                      
            <c:HPP_Loading ></c:HPP_Loading>
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
          

            <div id="fade"></div>
            <div id="overlay">
                Taking payment...
                <br />
                <br />
                This may take a few seconds.
                <div style="padding-top: 50px;">
                    <!--  CPDR01
                    <img src="{!URLFOR($Resource.ibbstyle, 'images/269.gif')}"></img>
                        -->
                    <img src="{!URLFOR($Resource.ibbstyleexternal, 'graphics/logos/circular-timer.gif')}"></img>
                </div>
            </div>
        </apex:form>
    </body>
</apex:page>