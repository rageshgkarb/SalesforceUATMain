<apex:page controller="HPPUnderwriterDecisionController"
    sidebar="false" showHeader="false" action="{!Setup}">
    <head>
<c:KendoResource ></c:KendoResource>

<style>
.Section {
    padding: 20px;
}

.valtitle {
    text-align: right;
    padding-right: 10px;
    padding-top:3px;
    padding-bottom:3px;
    font-weight: bold;
}

.numberVal {
    text-align: right;
    padding-right: 10px;
}

.box {
    border: solid 1px #666;
    padding: 10px;
}

.highLight {
    border: solid 2px red;
}

.bpRow {
    height:32px;
}
</style>


    </head>
    <body>
        <apex:form > 
            <div id="formWrapper">
                <!-- C00095-->
                <c:HPPSummary objAcc="{!Accounts[0]}" objOpp="{!opp}"
                    objExOpp="{!ExOpp}" Product="{!Prod}" />
                <div id="container">
                    <table width="100%">
                        <tr>
                            <td valign="top" id="sidebar"><c:HPPBOMenu oppId="{!Opp.Id}"
                                    DirectorId="{!Opp.ProductEventDirector__c}" /></td>
                            <td valign="top" id="contenttd">
                                <div id="content">
                                    <h1>Underwriter Assesment</h1>
                                    <apex:pageMessages ></apex:pageMessages>
                                    <ul id="asspanelbar">
                                        <li class="k-state-active"><span
                                            class="k-link k-state-selected">Section A: Application
                                                Information</span>
                                            <div>
                                                <apex:outputPanel id="affordUP">
                                                <div class="Section">
                                                        <apex:commandbutton styleclass="blueBtn"
                                                                            action="{!RerunAffordability}" value="Rerun Affordibility" disabled="{!IsCompleted}" />
                                                    <c:Underwriter_Application_Info rendered="{!!IsBTL}"
                                                        gross="{!TotalGross}" net="{!TotalNet}" total="{!Aggregation}"
                                                        res="{!Affordability}"></c:Underwriter_Application_Info>
                                                    <c:Underwriter_Application_BTL_Info rendered="{!IsBTL}"
                                                                                        gross="{!TotalGross}" net="{!TotalNet}" total="{!Aggregation}" isBTLLC="{!IsBTLLC}"
                                                                                        res="{!Affordability}" minimumrentalincome="{!minimumRentalIncome}" minimumrentalincomedeficit="{!minimumRentalIncomeDeficit}"
                                                                                        prarentalincome="{!PRARentalIncome}" prarentalincomedeficit="{!PRARentalIncomeDeficit}" pracoverage="{!PRACoverage}" totalcharges="{!TotalCharges}" failsbp="{!FailsBP}" isiaa="{!isIAA}"></c:Underwriter_Application_BTL_Info>
                                                </div>
                                                </apex:outputPanel>
                                            </div></li>
                                        <li><span class="k-link">Section B: Existing
                                                Customer Asset Information</span>
                                            <div>
                                                <div class="Section">
                                                    <c:Underwritter_Existing_Asset accounts="{!IBBAccounts}"></c:Underwritter_Existing_Asset>
                                                </div>
                                            </div></li>
                                        <li><span class="k-link">Section C: Current Asset
                                                Applications within Pipeline</span>
                                            <div>
                                                <div class="Section">
                                                    <c:Underwriter_Pipeline_Asset accounts="{!IBBAccountsPipeline}"></c:Underwriter_Pipeline_Asset>
                                                </div>
                                            </div></li>
                                        <li><span class="k-link">Section D: Existing
                                                Customer Liability Information</span>
                                            <div>
                                                <div class="Section">
                                                    <c:Underwriter_Existing_Liability accounts="{!IBBAccountsLiability }"></c:Underwriter_Existing_Liability>
                                                </div>
                                            </div></li>

                                    </ul>

                                    <div style="min-height: 800px;">
                                        <div id="asstabstrip">
                                            <ul>


                                                <apex:repeat value="{!Credits}" var="a">

                                                    <li>Credit Response ({!a.Prospect_Customer__r.Name})</li>
                                                </apex:repeat>

                                                <li>Application Data</li>
                                                <li>Underwriting Assessment</li>
                                                <li><apex:outputtext rendered="{!!IsBTLLC}">Budget Planner</apex:outputtext><apex:outputtext rendered="{!IsBTLLC}">Service Charges</apex:outputtext></li>
                                            </ul>



                                            <apex:repeat value="{!Credits}" var="a">
                                                <div>
                                                    <iframe frameBorder="0" width="100%" height="20000"
                                                        src="{!XmlViewerUrl}{!a.Decision_ID__c}"> </iframe>
                                                </div>
                                            </apex:repeat>

                                            <div>
                                            
                                            
                                                <apex:outputpanel rendered="{!oDirector.IsMMR__c && !isBTLLC}">
                                                    <iframe frameborder="0" width="100%" height="1200"
                                                            src="/apex/MMR_FF_PropertyDetails?credit=true&id={!EventLog.id}"></iframe>
                                                </apex:outputpanel>
                                                <apex:outputpanel rendered="{!oDirector.IsMMR__c && isBTLLC}">
                                                    <iframe frameborder="0" width="100%" height="1200"
                                                            src="/apex/MMR_FF_BTLLC_PropertyDetails?credit=true&id={!EventLog.id}"></iframe>
                                                </apex:outputpanel>
                                            <apex:outputPanel rendered="{!!oDirector.IsMMR__c}">
                                                <iframe frameBorder="0" width="100%" height="1200"
                                                    src="/apex/HPPUnderwritterApp1?id={!EventLog.id}">
                                                </iframe>
                                            </apex:outputPanel>
                                            
                                                
                                            </div>
                                            <div>
                                                <!---start of pasted in code-->
                                                <div style="padding-top: 30px;">
                                                    <apex:outputPanel id="uwPanel">
                                                        <div style="padding: 20px;">

                                                            <apex:repeat value="{!Accounts}" var="accs">
                                                                <h2>{!accs.name}</h2>
                                                                <h3>Status : {!Status[accs.id]}</h3>

                                                                <table class="list" style="width: 100%;">
                                                                    <tbody>
                                                                        <tr class="headerRow">
                                                                            <th>Referral Code</th>
                                                                            <th>Detail</th>
                                                                            <th>Referral addressed</th>
                                                                            <TH>BDM Comments</th>
                                                                            <th>Credit Accepted</th>
                                                                            <th>Credit Comments</th>
                                                                        </tr>

                                                                        <apex:repeat value="{!Cases[accs.id]}" var="cas">
                                                                            <tr class="dataRow">

                                                                                <td><a href="/{!cas.id}">{!cas.CaseNumber
                                                                                        }</a></td>
                                                                                <td>{!cas.Description}</td>
                                                                                <td>{!cas.Satisfied__c}</td>

                                                                                <td>{!cas.Comments__c}</td>
                                                                                <td><apex:inputField value="{!cas.Credit_accepted__c}" />
                                                                                </td>
                                                                               
                                                                                <td><apex:inputField value="{!cas.Credit_comments__c}" />
                                                                                </td>

                                                                            </tr>

                                                                        </apex:repeat>
                                                                    </tbody>
                                                                </table>

                                                            </apex:repeat>

                                                            <apex:commandButton styleClass="redBtn"
                                                                value="Save Cases" action="{!SaveCases}"
                                                                rendered="{!!IsCompleted}" />
                                                        </div>






                                                        <div style="text-align: right; height: 60px;">
                                                            <span class="box">Authority level required :</span> <span
                                                                class="box"><apex:outputLabel value="{!AuthLevel}"></apex:outputLabel>
                                                            </span>
                                                        </div>
                                                    <!--  <br />{!totalLib} -->
    
    <div style="padding: 10px;">
                                                            <div>
                                                                <table width="100%">
                                                                    <tr>
                                                                        <td>Submission Quality</td>
                                                                        <td><apex:inputField value="{!ExOpp.Submission_quality__c}" />
                                                                        </td>
                                                                        <td>Submission Quality Notes</td>
                                                                        <td><apex:inputTextarea value="{!ExOpp.Submission_quality_notes__c}"
                                                                                style="width: 300px;" rows="2" />
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Exception</td>
                                                                        <td><apex:inputField value="{!ExOpp.Exception__c}" />
                                                                        </td>
                                                                        <td>Exception Notes</td>
                                                                        <td><apex:inputTextarea value="{!ExOpp.Exception_notes__c}"
                                                                                style="width: 300px;" rows="2" /></td>
                                                                    </tr>
                                                                    
                                                                    <tr id="exceptionReasonRow1">
                                                                        <td>1st Exception - Reason Level 1</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel1-1" id="noKendo1-1" value="{!ExOpp.Exception_Reason_L1__c}" />
                                                                        </td>
                                                                        <td>1st Exception - Reason Level 2</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel1-2" id="noKendo1-2" value="{!ExOpp.Exception_Reason_L2__c}"/></td>
                                                                    </tr>
                                                                    
                                                                    <!-- C0068 start -->
                                                                    <tr id="exceptionReasonRow2" style="{!IF(ISBLANK(ExOpp.X2nd_Exception_Reason_L1__c), 'display: none;', '')}">
                                                                        <td>2nd Exception - Reason Level 1</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel2-1" id="noKendo2-1" value="{!ExOpp.X2nd_Exception_Reason_L1__c}" />
                                                                        </td>
                                                                        <td>2nd Exception - Reason Level 2</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel2-2" id="noKendo2-2" value="{!ExOpp.X2nd_Exception_Reason_L2__c}"/></td>
                                                                    </tr>
                                                                    
                                                                    <tr id="exceptionReasonRow3" style="{!IF(ISBLANK(ExOpp.X3rd_Exception_Reason_L1__c), 'display: none;', '')}">
                                                                        <td>3rd Exception - Reason Level 1</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel3-1" id="noKendo3-1" value="{!ExOpp.X3rd_Exception_Reason_L1__c}" />
                                                                        </td>
                                                                        <td>3rd Exception - Reason Level 2</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel3-2" id="noKendo3-2" value="{!ExOpp.X3rd_Exception_Reason_L2__c}"/></td>
                                                                    </tr>
                                                                    
                                                                    <tr id="exceptionReasonRow4" style="{!IF(ISBLANK(ExOpp.X4th_Exception_Reason_L1__c), 'display: none;', '')}">
                                                                        <td>4th Exception - Reason Level 1</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel4-1" id="noKendo4-1" value="{!ExOpp.X4th_Exception_Reason_L1__c}" />
                                                                        </td>
                                                                        <td>4th Exception - Reason Level 2</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel4-2" id="noKendo4-2" value="{!ExOpp.X4th_Exception_Reason_L2__c}"/></td>
                                                                    </tr>
                                                                    
                                                                    <tr id="exceptionReasonRow5" style="{!IF(ISBLANK(ExOpp.X5th_Exception_Reason_L1__c), 'display: none;', '')}">
                                                                        <td>5th Exception - Reason Level 1</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel5-1" id="noKendo5-1" value="{!ExOpp.X5th_Exception_Reason_L1__c}" />
                                                                        </td>
                                                                        <td>5th Exception - Reason Level 2</td>
                                                                        <td><apex:inputField styleclass="ReasonLevel5-2" id="noKendo5-2" value="{!ExOpp.X5th_Exception_Reason_L2__c}"/></td>
                                                                    </tr>
                                                                    <!--C0068 end -->
                                                                    
                                                                    <!-- WG Changes - 20/11/2014 -->
                                                                    <tr id="addExceptionReasonButtonRow">
                                                                        <td colspan="4">
                                                                            <button id="addExceptionReasonButton" onclick="addExceptionReason(); return false;" style="{!IF(ISBLANK(ExOpp.X2nd_Exception_Reason_L1__c) || ISBLANK(ExOpp.X3rd_Exception_Reason_L1__c) || ISBLANK(ExOpp.X4th_Exception_Reason_L1__c) || ISBLANK(ExOpp.X5th_Exception_Reason_L1__c), '', 'display: none;')}">Add Exception</button>
                                                                            <button id="removeLastExceptionButton" onclick="removeLastExceptionRow(); return false;" style="{!IF(NOT(ISBLANK(ExOpp.X2nd_Exception_Reason_L1__c)) || NOT(ISBLANK(ExOpp.X3rd_Exception_Reason_L1__c)) || NOT(ISBLANK(ExOpp.X4th_Exception_Reason_L1__c)) || NOT(ISBLANK(ExOpp.X5th_Exception_Reason_L1__c)), '', 'display: none;')}">Remove Exception</button>
                                                                        </td>
                                                                    </tr>
                                                                    <!-- End of WG Changes - 20/11/2014 -->
                                                                    
                                                                    <tr id="ExceptionOther">
                                                                        <td colspan="2">
                                                                        </td>
                                                                        <td>Exception - Reason Other</td>
                                                                        <td><apex:inputTExtArea value="{!ExOpp.Exception_Reason_Other__c}" style="width: 300px;" rows="2"/></td>
                                                                    </tr>
                                                                    
                                                                    <tr>
                                                                        <td valign="top">Is this a credit impaired customer?</td>
                                                                        <td valign="top"><apex:inputField value="{!Opp.Credit_Impaired_Customer__c}" />
                                                                        </td>
                                                                        <td colspan="2" width="50%">
                                                                        <div style="padding:10px;border: solid 1px #888;">
                                                                        <div style="padding:15px;">
                                                                        Credit Impaired Customer:
                                                                        <ul style="padding-left:0;">
<li>within the last two years has owed overdue payments, in an amount equivalent to three months’ payments, on a mortgage or other loan (whether secured or unsecured), except where the amount overdue reached that level because of late payment caused by errors by a bank or other third party; or</li>
<li>has been the subject of one or more county court judgments, with a total value greater than £500, within the last three years; or</li>
<li>has been subject to an individual voluntary arrangement or bankruptcy order which was in force at any time within the last three years.</li>
                                                                        </ul>
                                                                         </div>
                                                                         </div>
                                                                        </td>
                                                                   
                                                                    </tr>


                                                                </table>
                                                            </div>
                                                            
                                                            <div style="padding-top: 20px;">
                                                                <div>
                                                                    <h3>Credit Assessment Rationale</h3>
                                                                </div>
                                                                <!--<apex:inputField value="{!Opp.Credit_Assessment_Rationale__c}" />-->
                                                                <apex:inputTextarea styleClass="autoText"
                                                                    value="{!Opp.Credit_Assessment_Rationale__c}"
                                                                    style="width:100%" rows="2" />
                                                            </div>
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
<div style="padding-top:20px;">
         <h3>Valuation Report</h3>
    <div class="pbBody">
 
        <table class="list" width="100%">
            <thead>
                <tr class="headerRow">                  
                    <th class="headerRow">Document</th>
                   
                                                 
                </tr>
            </thead>
            <tbody>
            <apex:repeat value="{!atts}" var="a">
            <tr>
                <td><a target="_blank" href="/servlet/servlet.FileDownload?file={!a.id}"> {!a.name}</a></td>
               
                
            </tr>
             </apex:repeat>
            </tbody>
            </table>
            
            </div>
    </div>
    
    <div style="padding-top:20px;">
         <h3>Security Address</h3>
         
         <table width="100%">
             <tr>
                 <td> New property street</td>
                 <td class="box">{!Opp.New_property_street__c}</td>
                 <td>New property country</td>
                 <td class="box">{!Opp.New_property_country__c}</td>
             </tr>
             <tr>
                 <td>New property city</td>
                 <td class="box">{!Opp.New_property_city__c}</td>
                 <td>New property postcode</td>
                 <td class="box">{!Opp.New_property_postcode__c}</td>
             </tr>
         
         </table>        
    </div>    
    
    <div style="padding-top:20px;">
        <h3>Valuation Fields</h3>        
        <table width="100%">
            <tr>
                <td width="20%">Property type</td>
                <td width="30%">{!ValReport.Property_Type__c}</td>
                <td>Residential Dwelling</td>
                <td>{!ValReport.Residential_Dwelling__c}</td>
            </tr>
            <tr>
                <td>Property location type</td>
                <td>{!ValReport.Property_Location_Type__c}</td>
                <td>Parking</td>
                <td>{!ValReport.Parking__c}</td>
            </tr>
            <tr>
                <td>Tenure</td>
                <td>{!ValReport.Property_Tenure__c}</td>
                <td>How Many Parking Spaces</td>
                <td>{!ValReport.How_Many_Parking_Spaces__c}</td>
            </tr>
            <tr>
                <td>Unexpired term</td>
                <td>{!ValReport.Unexpired_Term__c}</td>
                <td>Garage</td>
                <td>{!ValReport.Garage__c}</td> 
            </tr>
            <tr>
                <td>Year Built</td>
                <td>{!ValReport.Year_Built__c}</td>
                <td>Level of Market Demand for Property</td>
                <td>{!ValReport.Rate_Market_Demand_for_Property__c}</td>
            </tr>
            <tr>
                <td>Walls</td>
                <td>{!ValReport.Walls__c}</td>
                <td>Service/Maintenance Charges</td>
                <td>{!ValReport.Service_Maintenance_Charges__c}</td>
            </tr>
            <tr>
                <td>Roof</td>
                <td>{!ValReport.Roof__c}</td>
                <td>Ground Rent</td>
                <td>{!ValReport.Ground_Rent__c}</td>
            </tr>
            <tr>
                <td>Floor Number</td>
                <td>{!ValReport.Floor_Number__c}</td>
                <td>Market value present condition</td>
                <td> <apex:outputText value="£{0, number, ###,##0}">
   <apex:param value="{!ValReport.Market_Value_Present_Condition__c}"/>
 </apex:outputText></td>
            </tr>
            <tr>
                <td width="20%">Number of bedrooms</td>
                <td width="30%">{!ValReport.Number_of_Bedrooms__c}</td>
                <td>Market value after repairs/completion</td>
                <td><apex:outputText value="£{0, number, ###,##0}">
   <apex:param value="{!ValReport.Market_Value_After_Repairs_Completion__c}"/>
 </apex:outputText></td> 
            </tr>
            <tr>
                <td>Number of floors</td>
                <td>{!ValReport.Number_of_Floors__c}</td>
                <td>Building reinstatement value</td>
                <td>
                <apex:outputText value="£{0, number, ###,##0}">
   <apex:param value="{!ValReport.Building_reinstatement_value__c}"/>
 </apex:outputText>
                
                </td>
            </tr>
                    
            <tr>
                <td colspan="2"></td>
                <td>Fair Market Rental (pcm)</td>
                <td>
                <apex:outputText value="£{0, number, ###,##0}">
   <apex:param value="{!ValReport.Fair_Market_Rental_pcm__c}"/>
 </apex:outputText>                                
                </td>                 
            </tr>
            <!--HPP-AVM C0785;Start -->
            <tr>
                <td> AVM Outcome</td>
                <td> {!ExOpp.AVM_OutCome__c}</td>
                <td> AVM Confidence Level</td>
                <td>{!ValReport.AVM_Confidence_Level__c}</td>
                </tr>
            <tr>
                <td>Report Status</td>
                <td>{!ValReport.ReportStatus__c}</td>
                <td>Valuation Expiry Date</td>
                <td>{!ValReport.Valuation_Expiry_Date__c}</td>
            </tr>
            <!--HPP-AVM C0785;End -->
        </table>
    </div>                                                              
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            
                                                            

                                                            

                                                            <div style="padding-top: 20px;">
                                                                <h3>Further Information Section</h3>


                                                                <div class="pbBody">
                                                                    <apex:variable value="{!0}" var="rowNumFi" />
                                                                    <table class="list" width="100%">
                                                                        <thead>
                                                                            <tr class="headerRow">
                                                                                <th class="headerRow">F.I Code</th>
                                                                                <th class="headerRow">Detail</th>
                                                                                <th class="headerRow">BDM Comments</th>
                                                                                <th class="headerRow">FI Reason</th>
                                                                                <th class="headerRow">Credit Accepted</th>
                                                                                <th class="headerRow">Underwriter Comments</th>
                                                                                <th class="headerRow">Action</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>

                                                                            <apex:repeat value="{!FiCases}" var="c">

                                                                                <tr>
                                                                                    <td><a href="/{!c.id}">{!c.CaseNumber }</a>
                                                                                    </td>
                                                                                    <td valign="top"><apex:inputTextarea rows="2"
                                                                                            style="width:100%;"
                                                                                            value="{!c.Further_Information__c}" />
                                                                                    </td>
                                                                                    <td>{!c.BDM_Comments__c}</td>
                                                                                    <td>
                                                                                    <apex:inputField value="{!c.FI_Reason__c}" />
                                                                                </td>
                                                                                    <td><apex:inputField value="{!c.Further_Info_Satisfied__c}" />
                                                                                    </td>
                                                                                    <td valign="top"><apex:inputTextarea rows="2"
                                                                                            style="width:100%;"
                                                                                            value="{!c.Underwriter_Comments__c}" />
                                                                                    </td>
                                                                                    <td vlaign="top">                                                                                    
                                                                                    <apex:commandLink oncomplete="SetUpDropdown();"
                                                                                                
                                                                                                action="{!DeleteFI}" value="Remove"
                                                                                                rerender="uwPanel" immediate="true"
                                                                                                rendered="{!!IsCompleted}">
                                                                                                <apex:param name="delFi"
                                                                                                    value="{!rowNumFi}"
                                                                                                    assignTo="{!delFi}" />
                                                                                            </apex:commandLink>
                                                                                    </td>
                                                                                </tr>
                                                                                <apex:variable var="rowNumFi"
                                                                                        value="{!rowNumFi+ 1}" />
                                                                            </apex:repeat>

                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                <div>
                                                                    <apex:commandLink reRender="uwPanel"
                                                                        styleClass="redBtn" value="Add Further Information"
                                                                        action="{!AddCase}" rendered="{!!IsCompleted}" />
                                                                    <div style="text-align: right;">
                                                                        <apex:commandLink reRender="uwPanel"
                                                                            styleClass="redBtn" value="Save Further Information"
                                                                            action="{!SaveFI}" rendered="{!!IsCompleted}" />
                                                                    </div>

                                                                </div>
                                                            </div>


                                                            <div style="padding-top: 20px;">
                                                                <apex:outputPanel id="criteriaPanel" >

                                                                    <h3>Special Conditions</h3>
                                                                    <div style="margin-bottom: 20px;">

     <input id="conditionDropdown" class="conditionDropdown" style="width:600px;"/>
                                   <apex:inputHidden id="DropDownValue"  value="{!SelectedCondition}" />
                                    <!--C0760 Process Optimization 2.0 start--> 
                                    <!--<apex:inputHidden value="{!Opp.Interested_in__c}" id="WhichProduct" />--> 
                                    <!--C0760 Process Optimization 2.0 end--> 
                                    <apex:commandButton oncomplete="SetUpDropdown();" status="save-lead-status" rendered="{!!IsCompleted}" reRender="uwPanel" value="Add Condition" action="{!AddCondition}"/>
                                    <apex:commandButton oncomplete="SetUpDropdown();" status="save-lead-status" rendered="{!!IsCompleted}" reRender="criteriaPanel" value="Delete Condition" action="{!BulkDeleteCondition}"/><!-- C0760 ; offer-letter Enhancement -->
                                                                    </div>

                                                                    <div class="pbBody">
                                                                        <apex:variable value="{!0}" var="rowNumProp" />

                                                                        <table class="list" width="100%">
                                                                            <thead>
                                                                                <tr class="headerRow">
                                                                                    <th class="headerRow">Select</th><!-- C0760 ; offer-letter Enhancement -->
                                                                                    <th class="headerRow">Action</th>
                                                                                    <th class="headerRow">Ref</th>
                                                                                    <th class="headerRow">Condition</th>
                                                                                    <th class="headerRow">UW</th>
                                                                                    <th class="headerRow">Reat</th>
                                                                                    <!--<th class="headerRow">Action</th>--><!-- C0760 ; offer-letter Enhancement -->
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                <apex:repeat value="{!Helper.CIList}" var="i">
                                                                                    <tr
                                                                                        class="{!IF(i.id = CurrentItem.id, 'highLight', '')}">
                                                                                        <!-- C0760 ; offer-letter Enhancement;Start -->
                                                                                        <td>
                                                                                        <apex:inputCheckbox id="DelCheckbox" value="{!i.deleteLine}" selected="{!i.deleteLine}" />
                                                                                        </td>
                                                                                        <!-- C0760 ; offer-letter Enhancement; End -->
                                                                                        <td><apex:commandLink oncomplete="SetUpDropdown();"
                                                                                                status="save-lead-status"
                                                                                                action="{!EditCondition}" value="Edit"
                                                                                                rerender="criteriaPanel" 
                                                                                                rendered="{!!IsCompleted}"> <!--immediate="true" -->
                                                                                                <apex:param name="edCondition"
                                                                                                    value="{!rowNumProp}" assignTo="{!edCondition}" />
                                                                                            </apex:commandLink></td>
                                                                                        <td><apex:outputLabel escape="false"
                                                                                                value="{!i.Ref}" /></td>
                                                                                        <td><apex:outputLabel escape="false"
                                                                                                value="{!i.Html}">
                                                                                            </apex:outputLabel></td>
                                                                                        <td><apex:inputCheckbox disabled="true"
                                                                                                value="{!i.UW_Allowed}" /></td>
                                                                                        <td><apex:inputCheckbox disabled="true"
                                                                                                value="{!i.Reat_Allowed}" /></td>
                                                                                                
                                                                                          
                                                                                                
                                                                                        <!-- C0760 ; offer-letter Enhancement; Commented out following code -->
                                                                                        <!--<td><apex:commandLink oncomplete="SetUpDropdown();"
                                                                                                status="save-lead-status"
                                                                                                action="{!deleteCondition}" value="Remove"
                                                                                                rerender="criteriaPanel" immediate="true"
                                                                                                rendered="{!!IsCompleted}">
                                                                                                <apex:param name="delCondition"
                                                                                                    value="{!rowNumProp}"
                                                                                                    assignTo="{!delCondition}" />
                                                                                            </apex:commandLink></td>-->

                                                                                    </tr>
                                                                                    <apex:variable var="rowNumProp"
                                                                                        value="{!rowNumProp+ 1}" />
                                                                                </apex:repeat>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>

                                                                    <div>                                                            
                                                                    
                                                                        <apex:outputPanel rendered="{!CurrentItem != null}">
                                                                        
                                                                        
                                                                        
                                                                        
                                                                            <div
                                                                                style="padding: 20px; border: solid 1px #ccc; margin-bottom: 20px;">
                                                                                <h2>Edit Condition</h2>
                                                                                <table width="100%">
                                                                                    <tr>
                                                                                        <td colspan="2">
                                                                                            <table width="100%">
                                                                                                <tr>
                                                                                                    <th>Code</th>
                                                                                                    <th>Title</th>
                                                                                                </tr>
                                                                                                <apex:repeat value="{!CurrentItem.Values}"
                                                                                                    var="val">
                                                                                                    <tr>
                                                                                                        <td>{!val.Code}</td>
                                                                                                        <td>{!val.Title}</td>

                                                                                                    </tr>
                                                                                                    <tr>
                                                                                                        <td colspan="2"><apex:inputTextArea styleClass="editor" style="width:100%"
                                                                                                                value="{!val.Value}" /></td>
                                                                                                    </tr>

                                                                                                </apex:repeat>
                                                                                            </table></td>

                                                                                    </tr>

                                                                                    <tr>
                                                                                        <td colspan="2">Who can satisfy as complete?</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td>UW</td>
                                                                                        <td>REAT</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td><apex:inputCheckbox disabled="true"
                                                                                                value="{!CurrentItem.UW_Allowed}" /></td>
                                                                                        <td><apex:inputCheckbox value="{!CurrentItem.Reat_Allowed}" />
                                                                                        </td>
                                                                                    </tr>                                                                                    
                                                                                    
                                                                                    <tr>
                                                                                        <td>Post completion condition?</td>
                                                                                        <td>Chase within (months)</td>
                                                                                    </tr>
                                                                                    
                                                                                    <tr>
                                                                                        <td><apex:inputCheckbox value="{!CurrentItem.PostCompletion}"/></td>
                                                                                        <td>
                                                                                            <apex:selectList size="1"   value="{!CurrentItem.Chasewithin}">
                                                                                               <apex:selectOption itemLabel="-- None --" itemvalue=""></apex:selectOption>
                                                                                               <apex:selectOption itemValue="1"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="2"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="3"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="4"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="5"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="6"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="7"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="8"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="9"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="10"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="11"></apex:selectOption>
                                                                                               <apex:selectOption itemValue="12"></apex:selectOption>
                                                                                           </apex:selectList>
                                                                                        </td>
                                                                                    </tr>
                                                                                    


                                                                                </table>

                                                                                <apex:commandButton oncomplete="SetUpDropdown();"
                                                                                    reRender="criteriaPanel" status="save-lead-status"
                                                                                    value="Save" action="{!Hide}" />
                                                                                <apex:commandButton oncomplete="SetUpDropdown();"
                                                                                    reRender="criteriaPanel" status="save-lead-status"
                                                                                    value="Quick Save" action="{!Save}" />
                                                                                <apex:commandButton oncomplete="SetUpDropdown();"
                                                                                    reRender="criteriaPanel" status="save-lead-status"
                                                                                    value="Cancel" action="{!Cancel}" />

                                                                            </div>
                                                                        </apex:outputPanel>
                                                                    </div>

                                                                </apex:outputPanel>

                                                            </div>
                                                        </div>



                                                        <apex:outputPanel rendered="{!!IsCompleted}">
                                                            <div>
                                                                <apex:outputPanel rendered="{!!OutsideAuth}">
                                                                    <span class="authBtn redBtn">Authorise</span>
                                                                </apex:outputPanel>

                                                                <apex:outputPanel rendered="{!OutsideAuth}">
                                                                    <span class="authoutBtn redBtn">Authorise</span>
                                                                </apex:outputPanel>


                                                                <apex:commandLink reRender="uwPanel" styleClass="redBtn"
                                                                    value="Save" action="{!FurtherInformation}" />
                                                                <!--<span class="finfoBtn redBtn">Save</span>-->
                                                                <span class="decBtn redBtn">Decline</span>






                                                            </div>
                                                            <apex:inputHidden id="hauthselected"
                                                                value="{!authSelected}" />
                                                            <div id="authoutWindow" style="display: none;">
                                                                <div style="text-align: center; padding: 20px;">
                                                                    You do not have authority to sanction the application.<br />
                                                                    <br /> Under whose authority are you sanctioning on? <br />
                                                                    <br />
                                                                    <table>
                                                                        <tr>
                                                                            <td>Limit of authority list</td>
                                                                            <td><apex:selectList value="{!authSelected1}" id="authLimit">
                                                                                    <apex:selectOptions value="{!AuthList}"></apex:selectOptions>
                                                                                </apex:selectList></td>
                                                                        </tr>
                                                                    </table>


                                                                </div>
                                                                <table width="100%">
                                                                    <tr>
                                                                        <td align="center"><apex:commandLink styleClass="redBtn" value="Save"
                                                                                action="{!AuthoriseOutside}" /></td>
                                                                        <td align="center"><span id="authoutWindow"
                                                                            class="redBtn">Cancel</span></td>
                                                                    </tr>
                                                                </table>
                                                            </div>

                                                            <div id="authWindow" style="display: none;">
                                                                <div style="text-align: center; padding: 20px;">
                                                                    Please confirm all mandatory fields have been
                                                                    completed.</div>
                                                                <table width="100%">
                                                                    <tr>
                                                                        <td align="center"><apex:commandLink styleClass="redBtn" value="Save"
                                                                                action="{!Authorise}" /></td>
                                                                        <td align="center"><span id="authWindowNo"
                                                                            class="redBtn">Cancel</span></td>
                                                                    </tr>
                                                                </table>
                                                            </div>

                                                            <div id="authoutWindow" style="display: none;">
                                                                <div style="text-align: center; padding: 20px;">
                                                                    Please confirm all mandatory fields have been
                                                                    completed.</div>
                                                                <table width="100%">
                                                                    <tr>
                                                                        <td align="center"><apex:commandLink styleClass="redBtn" value="Save"
                                                                                action="{!AuthoriseOutside}" /></td>
                                                                        <td align="center"><span id="authoutWindowNo"
                                                                            class="redBtn">No</span></td>
                                                                    </tr>
                                                                </table>
                                                            </div>

                                                            <div id="decWindow" style="display: none;">
                                                                <div style="text-align: center; padding: 20px;">
                                                                    Please confirm all mandatory fields have been
                                                                    completed.</div>
                                                                <table width="100%">
                                                                    <tr>
                                                                        <td align="center"><apex:commandLink styleClass="redBtn" value="Yes" action="{!Decline}" />
                                                                        </td>
                                                                        <td align="center"><span id="decWindowNo"
                                                                            class="redBtn">No</span></td>
                                                                    </tr>
                                                                </table>
                                                            </div>

                                                            <div id="finfoWindow" style="display: none;">
                                                                <div style="text-align: center; padding: 20px;">
                                                                    Please confirm all mandatory fields have been completed
                                                                    and further information cases have been applied.</div>
                                                                <table width="100%">
                                                                    <tr>
                                                                        <td align="center"><apex:commandLink styleClass="redBtn" value="Yes"
                                                                                action="{!FurtherInformation}" /></td>
                                                                        <td align="center"><span id="finfoWindowNo"
                                                                            class="redBtn">No</span></td>
                                                                    </tr>
                                                                </table>
                                                            </div>

                                                            <script>
 $(document).ready(function() {
                   var window = $("#authWindow");
                   var outwindow = $("#authoutWindow");
                   var decwindow = $("#decWindow");
                   var finfowindow = $("#finfoWindow");
                   
                       $('select[id*="authLimit"]').change(function(){
                       var v = $('select[id*="authLimit"]').val(); 
                       $('[id*="hauthselected"]').val(v);
  
                   });
                                                                       
                   $(".authBtn").click(function(){                   
                       if (!window.data("kendoWindow")) {
                        window.kendoWindow({
                            width: "300px",                            
                            title: "Authorised Decision",
                            modal: true
                            });                        
                        }
                        window.data("kendoWindow").open();                   
                        window.data("kendoWindow").center();                    
                    });                   
                   $("#authWindowNo").click(function(){
                       window.data("kendoWindow").close();
                   });
                   
                   $(".authoutBtn").click(function(){                   
                       if (!outwindow.data("kendoWindow")) {
                        outwindow.kendoWindow({
                            width: "400px",                            
                            title: "Authorised Decision",
                            modal: true
                            });                        
                        }
                        outwindow.data("kendoWindow").open();                   
                        outwindow.data("kendoWindow").center();                    
                    });                   
                   $("#authoutWindowNo").click(function(){
                       outwindow.data("kendoWindow").close();
                   });
                   
                   $(".decBtn").click(function(){                   
                       if (!decwindow.data("kendoWindow")) {
                        decwindow.kendoWindow({
                            width: "300px",                            
                            title: "Decline Decision",
                            modal: true
                            });                        
                        }
                        decwindow.data("kendoWindow").open();                   
                        decwindow.data("kendoWindow").center();                    
                    });                   
                   $("#decWindowNo").click(function(){
                       decwindow.data("kendoWindow").close();
                   });     
                   
                   $(".finfoBtn").click(function(){                   
                       if (!finfowindow.data("kendoWindow")) {
                        finfowindow.kendoWindow({
                            width: "300px",                            
                            title: "Decline Decision",
                            modal: true
                            });                        
                        }
                        finfowindow.data("kendoWindow").open();                   
                        finfowindow.data("kendoWindow").center();                    
                    });                   
                   $("#finfoWindowNo").click(function(){
                       finfowindow.data("kendoWindow").close();
                   });                   
                     
                       
               });   
</script>

                                                        </apex:outputPanel>

                                                    </apex:outputPanel>
                                                </div>




                                            </div>



                                        <!--  budget planner tab start -->
                                        <div>
                                        <apex:outputPanel id="budgetPanel" rendered="{!((isNewOverseasPolicyApplicable && Affordability.Less_rental_shortfall_premier__c == null)|| NOT(isNewOverseasPolicyApplicable))}"> <!-- Case: 01938975 - Added condition for existing budget planner to work for other products -->
                               <div class="pbBody">    
                               
                                    
                        <table class="list" width="100%">
                            <thead>
                            <tr>
                                <th colspan="2">
                                    <apex:inputField id="figures_dropdown" style="width:250px;" value="{!ExOpp.Budget_Figures__c}" rendered="{!!IsBTLLC}"/> 
                                    <apex:outputPanel >
                                        <script>
                                           try{
                                               if($('[id$="figures_dropdown"]') && '{!IsCompleted}'=='true'){
                                                   $('[id$="figures_dropdown"]').prop("disabled",true);
                                               }
                                           }catch(err){ }
                                        </script>
                                    </apex:outputPanel> 
                                </th>
                                <apex:outputpanel rendered="{!is_BP_V1}">
                                    <th colspan="2">Number of Cars in household</th>
                                    <th><apex:inputfield value="{!ExOpp.Number_of_cars__c}" />  </th>
                                </apex:outputpanel>
                                <apex:outputpanel rendered="{!is_BP_V2}">
                                    <th colspan="3">&nbsp;</th>
                                </apex:outputpanel>
                                <th><apex:commandbutton oncomplete="SetupBudgetPlanner();" value="Save" rerender="budgetPanel,affordUP" styleclass="redBtn" action="{!SaveBudget}" disabled="{!IsCompleted}" /></th>
                            </tr>
                            
                                <tr class="headerRow">
                                    <th class="headerRow">Type</th>
                                    <th class="headerRow" style="text-align:right;"> Customer/Bank INPUT</th>
                                    <th class="headerRow">BDM Comments</th>
                                    <th class="headerRow" style="text-align:right;">Al Rayan Bank Minimum</th>
                                    <th class="headerRow" style="text-align:right;">Figure to be used</th>
                                    <th class="headerRow" style="text-align:right;">Amount confirmed by Credit</th>
                                    <th class="headerRow" style="text-align:right;">Actual to be used</th>
                                </tr>
                            </thead>                        
                       <tbody>           
                       
                       <apex:repeat value="{!BudgetItems}" var="bi">
                      <tr class="bpRow">
                      <td>
                          <apex:outputtext value="{!bi.Item.Display_Name__c}" rendered="{!bi.Item.Display_Name__c!='HPP' || !IsBTL }" />
                          <apex:outputtext value="Residential property stressed repayment" rendered="{!bi.Item.Display_Name__c=='HPP' && IsBTL}" />   
                           </td>
                           <td align="right"><apex:outputText styleClass="bpInput" value="{0,number,£###,###,##0.00}" >
                                   <apex:param value="{!bi.Item.Applicant_Total__c}"/>
                               </apex:outputText>
                           </td>
                           <td><apex:outputText value="{!bi.item.BDM_Comments__c}" />
                                   
                           </td>
                      <td align="right"><apex:outputText styleClass="bpMin" value="{0,number,£###,###,##0.00}"    >
                                  <apex:param value="{!bi.Minimum}"/>
                          </apex:outputText>
                      </td>
                      <td align="right"><apex:outputText styleClass="bpUsed" value="{0,number,£###,###,##0.00}">
                                  <apex:param value="{!bi.FigureUsed}" />
                          </apex:outputText>
                      </td>
                      <td align="right">
                          <!--C0770 start-->
                          <!--<apex:inputfield styleclass="bpCredit" value="{!bi.Item.Credit_Value__c}" rendered="{!isCreditRiskUser || (!bi.Item.budgetPlannerConfig__r.Use_ONS_Only__c && bi.Item.Display_Name__c!='HPP' && bi.Item.Display_Name__c!='Income Assisted BTL Deficit') || (bi.Item.Display_Name__c=='HPP' && IsBTL)}" />-->
                          <!--<apex:outputtext styleclass="bpCredit" value="{!bi.item.Credit_Value__c}" rendered="{!!isCreditRiskUser && (bi.Item.budgetPlannerConfig__r.Use_ONS_Only__c || (bi.Item.Display_Name__c=='HPP' && !IsBTL))}"/>-->
                          <!--<apex:inputfield html-disabled="true" styleclass="bpCredit" value="{!bi.item.Credit_Value__c}" rendered="{!!isCreditRiskUser && (bi.Item.budgetPlannerConfig__r.Use_ONS_Only__c || (bi.Item.Display_Name__c=='HPP' && !IsBTL) || bi.Item.Display_Name__c=='Income Assisted BTL Deficit')}" />-->
                          <apex:inputfield styleclass="bpCredit" value="{!bi.Item.Credit_Value__c}" rendered="{!(isCreditRiskUser || bi.Item.Display_Name__c!='HPP' || (bi.Item.Display_Name__c=='HPP' && IsBTL)) && !IsCompleted}" />
                          <apex:inputfield html-disabled="true" styleclass="bpCredit" value="{!bi.item.Credit_Value__c}" rendered="{!(!isCreditRiskUser && bi.Item.Display_Name__c=='HPP' && !IsBTL) || IsCompleted}" />
                          <!--C0770 end-->
                      </td>                      
                      <td align="right"> <span class="toBeUsed">£0.00</span></td>
                    </tr>
                       </apex:repeat>
                       
                       <tr>
                           <td></td>
                           <td align="right"><b><span id="bpInput"></span></b></td>
                           <td align="right"></td>
                           <td align="right"><b><span id="bpMin"></span></b></td>
                           <td align="right"><b><span id="bpUsed"></span></b></td>
                           <td align="right"><b><span id="bpCredit"></span></b></td>
                           <td align="right"><b><span id="toBeUsed"></span></b></td>
                       </tr>
                       
                       </tbody>
                       </table>
                       <apex:commandButton oncomplete="SetupBudgetPlanner();" value="Save" reRender="budgetPanel,affordUP" styleClass="redBtn" action="{!SaveBudget}" disabled="{!IsCompleted}"/>
                       </div>
                       </apex:outputPanel>
                                        
                                        
                                        
                                        
                                                                   
                                        <!-- Case: 01938975 - New mini budget planner ; start -->  

  <style>
.Premiertable{
  width:70%;
  margin-left: auto;
  margin-right: auto;
  border: 1px solid black;
  border-collapse: collapse;
  margin-top: 30px;
  margin-bottom: 30px;
}
.Premierstyle{
  padding: 5px; 
}
.PremierspecialRows{
  background-color:#b3995d;
  font-weight: bold;
  color: #FFFFFF;
  
}
.premierBtn { 
    box-shadow:#EAECEE;
    background-color: #EAECEE;  
    border-radius: 3px;
    border: 1px solid #000000;
    display: inline-block;
    color: #000000;
    font-family: arial;
    font-size: 13px;
    //font-weight: bold;
    padding: 4px 9px;
    text-decoration: none;
    }
.redBtn2{
         -moz-box-shadow: inset 0px 1px 0px 0px #b3995d;
        -webkit-box-shadow: inset 0px 1px 0px 0px #b3995d;
        box-shadow: inset 0px 1px 0px 0px #b3995d;
        background: -webkit-gradient( linear, left top, left bottom, color-stop(0.05, #b3995d;), color-stop(1, #b3995d;) );
        background: -moz-linear-gradient( center top, #b3995d; 5%, #b3995d; 100% );
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#f24537', endColorstr='#c62d1f');
        background-color: #EAECEE;
        -moz-border-radius: 3px;
        -webkit-border-radius: 3px;
        border-radius: 3px;
        border: 1px solid #000000;
        display: inline-block;
        color: #000000;
        font-family: arial;
        font-size: 13px;
        font-weight: bold;
        padding: 4px 9px;
        text-decoration: none;
        /* text-shadow: 1px 1px 0px #810e05;
    }
</style>    
<script>
function TotalPremierFinancialCommitment(){
                    var total = 0;
                    $("[id$='premierCredit']").each(function(){
                        console.log('entering in calculation loop');
                        var val = parseFloat($(this).val()=='' ? 0 : $(this).val().replace('£','').replace(',',''));
                        console.log('TotalCredit.val='+val+'Actual value='+$(this).val());
                        
                        if(!isNaN(val))
                           total += val;
                    });
                    console.log('Total Finance'+total );
                    $('#TalFinanceCommitment').html(total.toLocaleString("en-GB", {style: "currency", currency: "GBP", minimumFractionDigits: 2}));
                    
                    var LessRentalShortfall= parseFloat($("[id$='RentalShortfall']").html().replace('£','').replace(',',''));
                    var FourtypercentOfNMI = parseFloat($("[id$='FourtyperOfNMI']").html().replace('£','').replace(',',''));
                    console.log('LessRentalShortfall'+LessRentalShortfall+'FourtypercentOfNMI '+FourtypercentOfNMI );
                    var talDeductions =  total + LessRentalShortfall +  FourtypercentOfNMI;
                    console.log('talDeductions '+talDeductions );
                    var TalNMI = parseFloat($("[id$='TotalNMI']").html().replace('£','').replace(',',''));                                
                    var SurplusOrDeficit  =  TalNMI - talDeductions;
                    console.log('SurplusOrDeficit '+SurplusOrDeficit);
                    talDeductions  = talDeductions.toLocaleString("en-GB", {style: "currency", currency: "GBP", minimumFractionDigits: 2});
                    $('#TalDeductions').html(talDeductions); 
                    
                    
                    TalNMI = TalNMI.toLocaleString("en-GB", {style: "currency", currency: "GBP", minimumFractionDigits: 2});
                    if(SurplusOrDeficit > 0){
                        $('#SurOrDeficit').html(TalNMI+' - '+talDeductions+' = ' + SurplusOrDeficit.toLocaleString("en-GB", {style: "currency", currency: "GBP", minimumFractionDigits: 2})+ ' (Pass)'); 
                    }else{
                        $('#SurOrDeficit').html(TalNMI+' - '+talDeductions+' = -' + SurplusOrDeficit.toLocaleString("en-GB", {style: "currency", currency: "GBP", minimumFractionDigits: 2}).replace('-','')+ ' (Fail)');     
                    }
                    
                                                 
                }
                window.onload = function() {
                    console.log('Total Financial Comitment loop');
                    TotalPremierFinancialCommitment();
                }
</script>                      
                        <apex:outputPanel rendered="{!(isNewOverseasPolicyApplicable && (Affordability.Less_rental_shortfall_premier__c!= null && Affordability.Less_rental_shortfall_premier__c > 0))}">
                        
                        <apex:outputPanel id="PremimerBudgetPanel">
                          <table class="Premiertable">
                          <tr style="border: 1px solid black;">
                            <th class="Premierstyle PremierspecialRows" align="left" colspan="4">Net monthly income of Applicants</th>
                            
                          </tr>
                          
                          <tr>
                            <td class="Premierstyle" align="left" colspan="2">Applicant1</td>
                            <td class="Premierstyle" align="left" colspan="2"><apex:outputtext value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.NetMonthlyIncomeApplicant1__c}" /></apex:outputtext></td>    
                          </tr> 
                          
                          <tr>
                            <td class="Premierstyle" align="left" colspan="2">Applicant2</td>
                            <td class="Premierstyle" align="left" colspan="2"><apex:outputtext value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.NetMonthlyIncomeApplicant2__c}" /></apex:outputtext></td>    
                          </tr>
                         
                          <tr rendered="{!Opp.Number_of_People_Applying__c > 2}">
                            <td class="Premierstyle" align="left" colspan="2">Applicant3</td>
                            <td class="Premierstyle" align="left" colspan="2"><apex:outputtext value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.NetMonthlyIncomeApplicant3__c}" /></apex:outputtext></td> 
                            
                          </tr>
                          
                          <tr rendered="{!Opp.Number_of_People_Applying__c > 3}">
                            <td class="Premierstyle" align="left" colspan="2">Applicant4</td>
                            <td class="Premierstyle" align="left" colspan="2"><apex:outputtext value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.NetMonthlyIncomeApplicant4__c}" /></apex:outputtext></td> 
                            
                          </tr>
                         
                          <tr>
                            <td class="Premierstyle PremierspecialRows" align="left" colspan="2">Total joint monthly Income</td>
                            <td class="Premierstyle PremierspecialRows" align="left" colspan="2"><apex:outputtext id="TotalNMI" value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.Total_joint_monthly_Income_premier__c}" /></apex:outputtext></td> 
                            
                          </tr>
                          <tr style="border: 1px solid black;">
                            <th class="Premierstyle PremierspecialRows" align="left" colspan="4">Financial Commitments</th>  
                          </tr>  
                          
                          <tr style="height:10px"> </tr>
                          
                          <apex:variable value="{!0}" var="rowNum"/>
                          <apex:repeat value="{!BudgetItems}" var="bi"> 
                          <tr>
                          <td align="Left"> Type:&nbsp;&nbsp; <apex:inputfield value="{!bi.Item.Name}"/></td>
                          <td align="Left"> Value:&nbsp;&nbsp;  <apex:inputfield value="{!bi.Item.Applicant_Total__c}" id="premierCredit"/ >
                          
                           </td> 
                          <td class="Premierstyle" align="Left" colspan="1"><apex:commandButton styleClass="btn-info" value="Remove" action="{!RemoveFinancialCommitments}" reRender="PremimerBudgetPanel" oncomplete="TotalPremierFinancialCommitment()" status="counterStatus1">
                                      <apex:param name="nickName" value="{!rowNum}" assignTo="{!rowDeleteFinancialCommitment}"/>
                                      </apex:commandButton>
                                      <apex:actionStatus id="counterStatus1"  startText=" (Removing...)"  stopText=""/>
                                      </td>
                          </tr>  
                          <apex:variable var="rowNum" value="{!rowNum + 1}"/>  
                          </apex:repeat>
                          
                         
                          
                          <tr> 
                          <th  align="lef" colspan="1">&nbsp;&nbsp;<apex:commandButton value="Add Financial Commitments" styleClass="premierBtn" action="{!AddBudgetPlanner}" reRender="PremimerBudgetPanel" oncomplete="TotalPremierFinancialCommitment()" status="counterStatus3"/>
                          <apex:actionStatus id="counterStatus3"  startText=" (Adding...)"  stopText=""/>
                          </th>
                          <th class="Premierstyle" align="Left" colspan="3"> 
                          &nbsp;&nbsp;<apex:commandButton value="Save All" action="{!SavePremierBudget}" styleClass="premierBtn " status="counterStatus2" oncomplete="TotalPremierFinancialCommitment()"/>
                                      <apex:actionStatus id="counterStatus2"  startText=" (Saving...)"  stopText=""/>
                                      </th> 
                          </tr>
                          
                          <tr style="height:10px"> </tr> 
                          <tr>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2">Total Financial Commitments</td>
                            <td class="Premierstyle PremierspecialRows" align="left" colspan="2"><span id="TalFinanceCommitment"></span></td> 
                          </tr>
                          <tr style="border: 1px solid black;">
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2">Less rental shortfall</td>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2"><apex:outputtext id="RentalShortfall" value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.Less_rental_shortfall_premier__c}" /></apex:outputtext></td>  
                          </tr>
                          
                          <tr>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2">Less 40% of Net Monthly Income </td>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2"><apex:outputtext id="FourtyperOfNMI" value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.Less_40_of_Net_Monthly_Income_premier__c}" /></apex:outputtext></td>  
                          </tr>
                          
                          <tr style="border: 1px solid black;">
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2">Total Deductions </td>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2"><apex:outputtext id="TalDeductions" value="{0,number,£#,###,##0.00}"><apex:param value="{!Affordability.Total_Deductions_premier__c}" /></apex:outputtext></td>  
                          </tr> 
                          
                          <tr>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2">Surplus/Deficit (Total joint monthly Income - Total Deductions)</td>
                          <td class="Premierstyle PremierspecialRows" align="left" colspan="2"><span id="SurOrDeficit"></span></td>  
                          </tr> 
                        </table>
                        </apex:outputPanel>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!(isNewOverseasPolicyApplicable && (Affordability.Less_rental_shortfall_premier__c!= null && Affordability.Less_rental_shortfall_premier__c == 0))}">
                        <div style="padding: 20px; border: solid 1px #ccc; margin-bottom: 20px;font-weight: bold;background-color: #b3995d;color: #000000;">
                        
                        This Opportunity has passed the affordability test.
                        
                        </div>
                        
                        </apex:outputPanel>
                        </div>
                       
                        <!-- Case: 01938975 - New mini budget planner; End-->
                                        <!--  budget planner tab end -->


                                        </div>
                                    </div>


                                </div></td>
                        </tr>
                    </table>
                </div>
            </div>


        </apex:form>


        <script id="template" type="text/x-kendo-tmpl">
           <div style="padding:10px;border: 1px solid black;">
           <table width="100%">
                 <tr>
                 <td width="100px">${ data.Code}</td>
                 <td>#= data.Template# </td>
                 </tr>
                 </table>
             </div>
         </script>

        <script>
            function addExceptionReason() {
                var addExceptionButton = document.getElementById("addExceptionReasonButton");
                var removeLastExceptionButton = document.getElementById("removeLastExceptionButton");

                var lastVisibleRow = getLastVisibleExceptionRow();
                console.log("Last visible row => " + lastVisibleRow);

                var nextRowToDisplay = null;
                if (lastVisibleRow == null)
                    nextRowToDisplay = 1;
                else if (lastVisibleRow < 5)
                    nextRowToDisplay = lastVisibleRow + 1;

                console.log("Next row to display => " + nextRowToDisplay);

                if (nextRowToDisplay != null) {
                    var rowToDisplay = document.getElementById("exceptionReasonRow" + nextRowToDisplay);
                    if (rowToDisplay) {
                        rowToDisplay.style.display = "table-row";
                    }
                }

                if (nextRowToDisplay == null || nextRowToDisplay == 5) {
                    addExceptionReasonButton.style.display = "none";
                }

                if (nextRowToDisplay != null && nextRowToDisplay > 1) {
                    removeLastExceptionButton.style.display = "inline-block";
                }
            }

            function removeLastExceptionRow() {
                var addExceptionButton = document.getElementById("addExceptionReasonButton");
                var removeLastExceptionButton = document.getElementById("removeLastExceptionButton");

                var lastVisibleRow = getLastVisibleExceptionRow();
                if (lastVisibleRow != null && lastVisibleRow != 1) {
                    var rowToRemove = document.getElementById("exceptionReasonRow" + lastVisibleRow);
                    if (rowToRemove) {
                        rowToRemove.style.display = "none";

                        var selectLists = rowToRemove.getElementsByTagName("select");
                        for (var i = 0; i < selectLists.length; ++i) {
                            var selectList = selectLists[i];
                            var options = selectList.getElementsByTagName("option");
                            for (var j = 0; j < options.length; ++j) {
                                var option = options[j];
                                option.selected = false;
                            }
                        }
                    }
                }

                if (lastVisibleRow == null || lastVisibleRow == 1 || lastVisibleRow == 2) {
                    addExceptionReasonButton.style.display = "inline-block";
                    removeLastExceptionButton.style.display = "none";
                }
            }

            function getLastVisibleExceptionRow() {
                var exceptionRow1 = document.getElementById("exceptionReasonRow1");
                var exceptionRow2 = document.getElementById("exceptionReasonRow2");
                var exceptionRow3 = document.getElementById("exceptionReasonRow3");
                var exceptionRow4 = document.getElementById("exceptionReasonRow4");
                var exceptionRow5 = document.getElementById("exceptionReasonRow5");

                var lastVisibleRow = null;
                if (isVisible(exceptionRow5))
                    lastVisibleRow = 5;
                else if (isVisible(exceptionRow4))
                    lastVisibleRow = 4;
                else if (isVisible(exceptionRow3))
                    lastVisibleRow = 3;
                else if (isVisible(exceptionRow2))
                    lastVisibleRow = 2;
                else if (isVisible(exceptionRow1))
                    lastVisibleRow = 1;

                return lastVisibleRow;
            }

            function isVisible(element) {
                if (element && element.style.display != "none") {
                    return true;
                }
                return false;
            }

            var carFields = {!JsonCarFields};

            function SetUpDropdown()
            {

            var spjson = {!JsonConditions};
            //C0760 Process Optimization 2.0 start
            //if($("[id$='WhichProduct']").val()=="Home Purchase Plan" || $("[id$='WhichProduct']").val()=="Buy To Let Purchase Plan"){
                $("[id$='DropDownValue']").val('');
                var myMultiselect = $('.conditionDropdown');
                myMultiselect.kendoMultiSelectBox({
                    dataTextField: "Code",
                    dataValueField: "Id",
                    dataSource: spjson,
                    template: '<div style="padding:10px;border: 1px solid black;"><table width="100%"><tr><td width="30px"><input type="checkbox" name="#= {1} #" value="#= {0} #" class="custom-multiselect-check-item" /></td><td width="100px">${ data.Code}</td><td>#= data.Template# </td></tr></table></div>',
                    width:800,
                    height:550,
                    emptySelectionLabel: "Please select...",
                    value: [""]
                });
                myMultiselect.data("kendoMultiSelectBox").bind("selectionChanged", function(e) {
                    console.log(e.newValue.length);
                    $("[id$='DropDownValue']").val(e.newValue);
                });
                /*}else{
                    var cmb =$(".conditionDropdown").kendoDropDownList({
                        dataTextField: "Code",
                        dataValueField: "Id",
                        template:kendo.template($("#template").html()),
                        width:800,
                        height:500,
                        select: function (e) {
                        var index = e.item.index();
                        var dataItem = this.dataItem(e.item.index());
                        $("[id$='DropDownValue']").val(dataItem.Id);
                        },
                        close:function(e){
            
                        },
                        dataSource: spjson
                    });
                    }*/
//C0760 Process Optimization 2.0 end

            
                $(".editor").kendoEditor({
                    encoded: false,
                    tools:[
                         "bold", "italic", "underline"


                    ]

                });
            }


            $(document).ready(function() {

            $('.autoText').autosize();
                SetUpDropdown();

                /*cmb.list.width(250);*/


                $("#asspanelbar").kendoPanelBar({

                    });


                    $("#asstabstrip").kendoTabStrip({

                    });

                   /*$('#xmlView').load('http://appsrv03//XMLDataViewer/CreditData?CallID=013E5F5A-0FA5-4043-9EF9-A4270EB65587l');
                    */
                });


                function TotalToBeUsed(){
                    var total = 0;
                    $('.toBeUsed').each(function(){

                       var val = parseFloat($(this).html().replace('£','').replace(',',''));
                       if(val  !== '' && !isNaN(val))
                           total += val;
                    });
                    $('#toBeUsed').html('£' + total.toFixed(2));
                }

                function TotalCredit(){
                    var total = 0;
                    $('.bpCredit').each(function(){
                        //C0770 start
                        var val = parseFloat($(this).val()=='' ? 0 : $(this).val().replace('£','').replace(',',''));
                        //console.log('TotalCredit.val='+val+'Actual value='+$(this).val());
                        //C0770 end
                        if(!isNaN(val))
                           total += val;
                    });
                    $('#bpCredit').html('£' + total.toFixed(2));
                }

                function SetupBudgetPlanner()
                {


                    $('.bpCredit').each(function(){
                         var tobeused = $(this).parent().parent().find('.toBeUsed');

                         var txtVal = $(this).val().replace(',','').replace('£','');
                         if(txtVal  === '')
                         {
                            // Check if this is within a span
            try{
                            txtVal = $(this).innerHTML().replace(',','').replace('£','');
                            console.log('txtVal='+txtVal+'Actual value='+$(this).val());
            }catch(err){ console.log(err); }
                         }

                         if(txtVal  === '')
                         {
                             var p = $(this).parent();

                             //C0770 start
                             //tobeused.html('£' + $(this).parent().parent().find('.bpUsed').html().replace('£',''));
                             try{
                                 var maxValue = Math.max($(this).parent().parent().find('.bpUsed').html().replace('£','').replace(',',''), $(this).parent().parent().find('.bpMin').html().replace('£','').replace(',',''))
                                 tobeused.html('£' + parseFloat(maxValue).toFixed(2));    
                             }catch(err){console.log(err);}
                             //C0770 end
                         }
                         else
                         {
                             tobeused.html('£' + txtVal.replace('£',''));
                         }
                     });

                    TotalToBeUsed();
                    TotalCredit();
                    SetupKendo();


                    var pbInputTotal = 0;
                    $('.bpInput').each(function(){
                        var inputVal =  $(this).html().replace('£','').replace(',','');
                        pbInputTotal += parseFloat(inputVal );
                    });
                    $('#bpInput').html('£' + pbInputTotal.toFixed(2));

                    var pbMinTotal = 0;
                    $('.bpMin').each(function(){

                        var inputVal = $(this).html().replace('£','').replace(',','');
                        pbMinTotal += parseFloat(inputVal );
                    });
                    $('#bpMin').html('£' + pbMinTotal.toFixed(2));

                    var pbUsedTotal = 0;
                    $('.bpUsed').each(function(){

                        var inputVal = $(this).html().replace('£','').replace(',','');
                        pbUsedTotal += parseFloat(inputVal );
                    });
                    $('#bpUsed').html('£' + pbUsedTotal.toFixed(2));

                     $('.bpCredit').change(function(){
                         var tobeused = $(this).parent().parent().find('.toBeUsed');

                         var txtVal = $(this).val().replace(/\s/g,'').replace(',','').replace('£','');


                         if(txtVal  === '' || isNaN(txtVal))
                         {
                             var p = $(this).parent();
                             //C0770 start
                             //tobeused.html('£' + $(this).parent().parent().find('.bpUsed').html().replace('£',''));
                             var maxValue = Math.max($(this).parent().parent().find('.bpUsed').html().replace('£','').replace(',',''), $(this).parent().parent().find('.bpMin').html().replace('£','').replace(',',''))
                             tobeused.html('£' + parseFloat(maxValue).toFixed(2));
                             //C0770 end
                             $(this).val('');
                         }
                         else
                         {
                             tobeused.html('£' + parseFloat(txtVal.replace('£','')).toFixed(2));
                         }
                         TotalToBeUsed();
                         TotalCredit();
                     });
                }

                 $(document).ready(function() {

                    $('.autoText').autosize();

                    SetupBudgetPlanner();



                    $(document).ready(function() {
  $(window).keydown(function(event){

    if(event.keyCode == 13) {

      var tagName = event.target.tagName.toLowerCase();


                           if (tagName.localeCompare('textarea') == 0) {
                               return true;
                           }
                           else
                           {
                               event.preventDefault();
                           }
    }
  });

  //$('').keydown(function(){
      //return true;

  //});


});






                });
        </script>

    </body>
</apex:page>